From 101f908ed3b66e3c3b0cac5750eaae21ef0d6964 Mon Sep 17 00:00:00 2001
From: Modestas Stankus <stankus.modestas@gmail.com>
Date: Tue, 24 Apr 2012 09:37:33 +0300
Subject: [PATCH] Citramona support

---
 arch/mips/include/asm/mach-ralink/machine.h     |    2 ++
 arch/mips/include/asm/mach-ralink/rt3883_regs.h |    1 +
 arch/mips/ralink/rt3883/Kconfig                 |    5 +++
 arch/mips/ralink/rt3883/Makefile                |    1 +
 arch/mips/ralink/rt3883/devices.c               |   38 ++++++++++++++++++++++-
 arch/mips/ralink/rt3883/devices.h               |    4 +++
 6 files changed, 50 insertions(+), 1 deletion(-)

diff --git a/arch/mips/include/asm/mach-ralink/machine.h b/arch/mips/include/asm/mach-ralink/machine.h
index eaef21a..bc9e628 100644
--- a/arch/mips/include/asm/mach-ralink/machine.h
+++ b/arch/mips/include/asm/mach-ralink/machine.h
@@ -57,4 +57,6 @@ enum ramips_mach_type {
 
 	/* RT3662 based machines */
 	RAMIPS_MACH_RT_N56U,		/* Asus RT-N56U */
+	RAMIPS_MACH_CITRAMONA,          /* "Citramona" */
+
 };
diff --git a/arch/mips/include/asm/mach-ralink/rt3883_regs.h b/arch/mips/include/asm/mach-ralink/rt3883_regs.h
index b36cabe..bb89de7 100644
--- a/arch/mips/include/asm/mach-ralink/rt3883_regs.h
+++ b/arch/mips/include/asm/mach-ralink/rt3883_regs.h
@@ -66,6 +66,7 @@
 #define RT3883_WLAN_SIZE	0x40000
 #define RT3883_USBHOST_SIZE	0x40000
 #define RT3883_BOOT_SIZE	(32 * 1024 * 1024)
+#define RT3883_CITRA_BOOT_SIZE	(8 * 1024 * 1024)
 #define RT3883_SRAM_SIZE	(32 * 1024 * 1024)
 
 /* SYSC registers */
diff --git a/arch/mips/ralink/rt3883/Kconfig b/arch/mips/ralink/rt3883/Kconfig
index 5aa040d..ae0c40d 100644
--- a/arch/mips/ralink/rt3883/Kconfig
+++ b/arch/mips/ralink/rt3883/Kconfig
@@ -8,6 +8,11 @@ config RT3883_MACH_RT_N56U
 	select RALINK_DEV_GPIO_BUTTONS
 	select RALINK_DEV_GPIO_LEDS
 
+config RT3883_MACH_CITRAMONA
+	bool "CITRAMONA support"
+	default y
+
+
 endmenu
 
 endif
diff --git a/arch/mips/ralink/rt3883/Makefile b/arch/mips/ralink/rt3883/Makefile
index 3068d58..4165c67 100644
--- a/arch/mips/ralink/rt3883/Makefile
+++ b/arch/mips/ralink/rt3883/Makefile
@@ -12,3 +12,4 @@ obj-y	:= irq.o setup.o devices.o rt3883.o clock.o
 obj-$(CONFIG_EARLY_PRINTK)		+= early_printk.o
 
 obj-$(CONFIG_RT3883_MACH_RT_N56U)	+= mach-rt-n56u.o
+obj-$(CONFIG_RT3883_MACH_CITRAMONA)     += mach-citramona.o
diff --git a/arch/mips/ralink/rt3883/devices.c b/arch/mips/ralink/rt3883/devices.c
index 8d394bb..f49eb7d 100644
--- a/arch/mips/ralink/rt3883/devices.c
+++ b/arch/mips/ralink/rt3883/devices.c
@@ -66,8 +66,30 @@ static struct platform_device rt3883_flash1_device = {
 	},
 };
 
+static struct resource rt3883_flash2_resources[] = {
+	{
+		.flags	= IORESOURCE_MEM,
+		.start	= RT3883_BOOT_BASE,
+		.end	= RT3883_BOOT_BASE + RT3883_CITRA_BOOT_SIZE - 1,
+	},
+};
+
+struct physmap_flash_data rt3883_flash2_data;
+static struct platform_device rt3883_flash2_device = {
+	.name		= "physmap-flash",
+	.resource	= rt3883_flash2_resources,
+	.num_resources	= ARRAY_SIZE(rt3883_flash2_resources),
+	.dev = {
+		.platform_data = &rt3883_flash2_data,
+	},
+};
+
+
 static int rt3883_flash_instance __initdata;
-void __init rt3883_register_pflash(unsigned int id)
+void __init __rt3883_register_flash(unsigned int id,
+				    struct mtd_partition *parts,
+				    unsigned int nr_parts)
+
 {
 	struct platform_device *pdev;
 	struct physmap_flash_data *pdata;
@@ -84,6 +106,11 @@ void __init rt3883_register_pflash(unsigned int id)
 		pdev = &rt3883_flash1_device;
 		reg = RT3883_FSCC_REG_FLASH_CFG1;
 		break;
+	case 2:
+		pdev = &rt3883_flash2_device;
+		reg = RT3883_FSCC_REG_FLASH_CFG0;
+		break;
+
 	default:
 		return;
 	}
@@ -115,6 +142,10 @@ void __init rt3883_register_pflash(unsigned int id)
 		pr_warn("RT3883: flash bank%d: invalid width detected\n", id);
 		return;
 	}
+	if (parts != NULL) {
+		pdata->parts = parts;
+		pdata->nr_parts = nr_parts;
+	}
 
 	pdev->id = rt3883_flash_instance;
 
@@ -122,6 +153,11 @@ void __init rt3883_register_pflash(unsigned int id)
 	rt3883_flash_instance++;
 }
 
+void __init rt3883_register_pflash(unsigned int id)
+{
+	__rt3883_register_flash(id, NULL, 0);
+}
+
 static atomic_t rt3883_usb_use_count = ATOMIC_INIT(0);
 
 static void rt3883_usb_host_start(void)
diff --git a/arch/mips/ralink/rt3883/devices.h b/arch/mips/ralink/rt3883/devices.h
index bbddc7e..56428e5 100644
--- a/arch/mips/ralink/rt3883/devices.h
+++ b/arch/mips/ralink/rt3883/devices.h
@@ -16,6 +16,10 @@ struct physmap_flash_data;
 extern struct physmap_flash_data rt3883_flash0_data;
 extern struct physmap_flash_data rt3883_flash1_data;
 void rt3883_register_pflash(unsigned int id);
+void __rt3883_register_flash(unsigned int id,
+				    struct mtd_partition *parts,
+				    unsigned int nr_parts);
+
 
 extern struct ramips_nand_platform_data rt3883_nand_data;
 void rt3883_register_nand(void);
-- 
1.7.9.5

